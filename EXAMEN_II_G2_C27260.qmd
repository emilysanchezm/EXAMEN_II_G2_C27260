---
title: "EXAMEN_II_G2_C27260"
author: "Emily Sánchez"
subtitle: "CA0204 - Herramientas de Ciencia de Datos I"
institute: "Universidad de Costa Rica"
titlepage: false
editor: visual
format:
  html:
    self-contained: true
    embed-resources: true
---

# 1

```{r}
# Carga de paquetes
library(tidyverse)
library(readr)

# carga de txt a r 
moras <- read_csv("~/Downloads/moras.txt", 
                  col_types =  cols(SALARIO = col_character()))

moras$SALARIO <- gsub(",", ".", moras$SALARIO)


```

# 2

```{r}
# Se agregan un resumen de los 5 números por variable cuantitativa
summary(moras$IDENTIFICACION)

summary(moras$EDAD)

moras$SALARIO <- as.numeric(moras$SALARIO)
summary(moras$SALARIO)

```

# 3

```{r}
library(dplyr)

moras <- moras %>% 
  mutate(
    # Se calcula Z-score para SALARIO y se determinan los valores atípicos.
    # Se usa la formula de Z-score para la media y desviación se omiten los NAs. Note que si el valor era NA se mantendrá como NA.
    ZSCORE_SALARIO = (SALARIO - mean(SALARIO, na.rm = TRUE)) / sd(SALARIO, na.rm = TRUE),
    
    # Se compara con 1.96 los NA siempre quedan como NAs 
    ATIPICO_SALARIO = abs(ZSCORE_SALARIO) > 1.96,
    
    # Análogo a lo de arriba.
    ZSCORE_EDAD = (EDAD - mean(EDAD, na.rm = TRUE)) / sd(EDAD, na.rm = TRUE),
    ATIPICO_EDAD = abs(ZSCORE_EDAD) > 1.96
  )

```

# 4

```{r}
# Se saca el porcentaje de NAs por variable/ columna.
# Se cuentan los NAs por columna, se dividen entre el número total de observaciones y se multiplica por 100 para obtener un porcentaje.
porcentaje_na <- colSums(is.na(moras)) / nrow(moras) * 100
porcentaje_na

```

# 5

```{r}
# Imputamos las numéricas por el promedio. 
moras$SALARIO <- ifelse(is.na(moras$SALARIO), # Condición lógica
                        mean(moras$SALARIO, na.rm = TRUE), # Si se cumple
                        moras$SALARIO) # Si no se cumple

moras$EDAD <- ifelse(is.na(moras$EDAD), 
                     mean(moras$EDAD, na.rm = TRUE), 
                     moras$EDAD)


# Se crea un función para encontrar la moda de la variable categórica.
moda <- function(x) {
  tab <- table(x)           # Se crea una tabla de frecuencias de cada tipo de aseguramiento.
  names(tab)[which.max(tab)]  # which.max() devuelve la posición del valor máximo en un vector y names (tab) devuelve los nombres de cada elemento de tab. Combinado, esta linea toma los nombres de tab y selecciona el que corresponde a la posición de la frecuencia máxima.
}

# Se imputa con la moda 
moras$TIPO_ASEGURAMIENTO[is.na(moras$TIPO_ASEGURAMIENTO)] <- moda(moras$TIPO_ASEGURAMIENTO)

```

# 6

```{r}
# Se hace una funcion que haga graficos donde se vea la cantidad de individuos por cada variable categórica. 
graficar_categorias <- function(df, var) {
  for (i in var) { # Se recorre cada nombre de cada variable 
    plot <- df %>%
      group_by(.data[[i]]) %>%   # agrupa por las categorías de la variable donde .data[[]] permite acceder los valores que contiene esa variable (columna).
      summarise(cantidad = n()) %>%  # Se cuenta por grupo la cantidad de asegurados.
      ggplot(aes(x = .data[[i]], y = cantidad, fill = .data[[i]])) + # se definen parametros x y y. Se llenan las barras dependiendo de la categoría.
      geom_bar(stat = "identity") + # Para que no cambie los parametros que se definieron en el aes. 
      labs(title = paste("Cantidad de individuos por", i), # titulo 
           x = i,
           y = "Cantidad") +
      theme_minimal() +
      theme(axis.text.x = element_blank()) # se quita los nombres de cada categoría en el eje x porque se ve redundante y para tipo_aseguramiento se ve feo. 
    print(plot)
  }
}

# Se define un vector con las columnas categóricas por graficar
categoricas <- c("SEXO", "SECTOR", "INDICADOR_ACTIVO", 
                 "INDICADOR.EXTRANJERO", "TIPO_ASEGURAMIENTO", 
                 "INDICADOR_MOROSO")

# Se llama a la función
graficar_categorias(moras, categoricas)

```

Note que son los mismos gráficos de excel por lo que es el mismo análisis

# 7

```{r}
library(scales)
typeof(moras$INDICADOR_MOROSO) # Tipo caracter no funciona para el cálculo 

# Se pasa la variable a numérica para poder usarla en la función
moras$INDICADOR_MOROSO <- ifelse(moras$INDICADOR_MOROSO == "SI", 1,
                                 ifelse(moras$INDICADOR_MOROSO == "NO", 0, NA))

colSums(is.na(moras)) / nrow(moras) * 100  # Se verifica que se haya hecho bien el cambio

# Función para graficar porcentaje de morosos por categoría
graficos_morosos <- function(df, var, indicador_moroso = "INDICADOR_MOROSO") {
  for (i in var) { # Se recorren los nombres de la var por graficar
    # Primero se agrupa por categoría y se calcula el porcentaje de morosos 
    resumen <- df %>%
      group_by(.data[[i]]) %>% # Se agrupan los datos por cada categoría de la variable, se explicó arriba.
      summarise(
        total = n(), # Se explicó arriba
        morosos = sum(.data[[indicador_moroso]] == 1), # Se cuentan las personas morosas, es decir las que tienen como indicador_moroso 1
        porcentaje = morosos / total * 100 # Se calcula el porcentaje dividiendo casos de interes entre casos totales y multiplicando por 100. 
      )
    
    # Luego se crean los gráficos de barras con los datos del tibble de arriba. 
    plot <- ggplot(resumen, aes(x = .data[[i]], y = porcentaje, fill = .data[[i]])) + # se explicó antes 
      geom_bar(stat = "identity") +  # se explicó antes 
      labs(  # se explicó arriba 
        title = paste("Porcentaje de personas morosas por", i),
        x = i,
        y = "Porcentaje (%)"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_blank()) + # se explicó antes 
      scale_y_continuous(breaks = pretty_breaks(n = 10)) # se hacen más ticks para poder ver mejor los porcentajes.(Se usó en el poryecto individual)
    print(plot)
  }
}

# Variables que se van a graficar 
categoricas2 <- c("SEXO", "SECTOR", "INDICADOR_ACTIVO", 
                 "INDICADOR.EXTRANJERO", "TIPO_ASEGURAMIENTO")

# Se llama a la función 
graficos_morosos(moras, categoricas2)
```

Note que son los mismos gráficos de excel, por lo que, es el mismo análisis

# 8

```{r}
# Se revierte el cambio que se hizo a la variable INDICADOR_MOROSO en el apartado anterior

moras$INDICADOR_MOROSO <- ifelse(moras$INDICADOR_MOROSO == 1,
                                 "SI",
                                 ifelse(moras$INDICADOR_MOROSO == 0, "NO", NA))

colSums(is.na(moras)) / nrow(moras) * 100  # Se verifica que se haya revertido bien el cambio


# Se calcula la edad promedio por condición de morosidad
edad_promedio <- moras %>%
  group_by(INDICADOR_MOROSO) %>% # Agrupamos a las personas por estado de morosidad 
  summarise(promedio = mean(EDAD))  # Se calulan los promedios de edades para cada grupo


# Se trabaja sobre el tibble que se obtuvo arriba
ggplot(edad_promedio,
       aes(x = INDICADOR_MOROSO, y = promedio, fill = INDICADOR_MOROSO)) + # Se explicó antes
  geom_bar(stat = "identity") + # Se explicó antes
  labs(
    title = "Edad promedio según morosidad",
    # Se explicó antes
    x = "Moroso",
    y = "Edad promedio"
  ) +
  theme_minimal() +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  coord_flip() # Se cambian coordenadas para que sea horizontal


# Mismo proceso para salario
salario_promedio <- moras %>%
  group_by(INDICADOR_MOROSO) %>%
  summarise(promedio = mean(SALARIO))


ggplot(salario_promedio,
       aes(x = INDICADOR_MOROSO, y = promedio, fill = INDICADOR_MOROSO)) +
  geom_bar(stat = "identity") +
  labs(title = "Salario promedio según morosidad", x = "Moroso", y = "Salario promedio") +
  theme_minimal() +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  coord_flip() 

```

Note que son los mismos gráficos de excel, por lo que, es el mismo análisis

# 10

```{r}
# Se convierten las variables categóricas a factor. Es importante, porque aquí se especifica que estas columnas son categorías o grupos.
moras$SEXO <- as.factor(moras$SEXO)
moras$SECTOR <- as.factor(moras$SECTOR)
moras$INDICADOR_ACTIVO <- as.factor(moras$INDICADOR_ACTIVO)
moras$INDICADOR.EXTRANJERO <- as.factor(moras$INDICADOR.EXTRANJERO)
moras$TIPO_ASEGURAMIENTO <- as.factor(moras$TIPO_ASEGURAMIENTO)
moras$INDICADOR_MOROSO <- as.factor(moras$INDICADOR_MOROSO)

# Recodificar tipo de aseguramiento. Se simplifican los nombres largos de la columna TIPO_ASEGURAMIENTO porque al imprimir el árbol de decisión sin esto no logran salir todas las categorías completas. 
moras$TIPO_ASEGURAMIENTO <- recode(moras$TIPO_ASEGURAMIENTO, 
  "ASALARIADO" = "A",
  "CONVENIOS ESPECIALES DE ASEGURADOS VOLUNTARIOS" = "CEAV",
  "ASEGURADO VOLUNTARIO" = "AV", 
  "TRABAJADOR INDEPENDIENTE" = "TI", 
  "PENSIONADOS EN SU PROPIO SISTEMA" = "PS",
  "CONVENIOS ESPECIALES DE TRABAJADORES INDEPENDIENTES" = "CETI"
)

# Se crea un dataframe sin identificador. La columna IDENTIFICACION es única para cada persona, entonces no aporta en nada tenerlo en el árbol de decisión. 
df_tree <- moras %>% select(-IDENTIFICACION)


# Se descargan las librerias correspondientes donde:
library(rpart) # Sirve para construir los árboles de decisión
library(rpart.plot) # Permite hacer plots de los árboles

# Se construye el árbol de clasificación. Se quiere predecir INDICADOR_MOROSO usando todas las demás columnas (.)
tree <- rpart(INDICADOR_MOROSO ~ ., data = df_tree, method = "class")

# Se grafica el árbol. Cex = 0.7 ajusta el tamaño del texto.
rpart.plot(tree, cex = 0.7)

```

El árbol de decisión es una herramienta visual que ayuda a comprender cómo ciertos factores de las personas aseguradas influyen en la probabilidad de que estas se vuelvan o no morosas. Su función principal es dividir a la población en grupos con características similares y estimar para cada uno de ellos qué tan probable es que tengan problemas de pago. Esto permite identificar perfiles de mayor y menor riesgo y, a partir de ello, tomar decisiones más informadas sobre gestión de cobros, políticas de seguimiento o estrategias de prevención.

Al iniciar la lectura del árbol, el primer elemento (nodo) contiene al 100% de la población donde la mayor parte del grupo no es moroso. Posteriormente, se observa una pregunta relacionada con el tipo de aseguramiento que tiene la persona. El modelo separa a todos los asegurados en dos grupos: quienes pertenecen a ciertos tipos específicos de aseguramiento (identificados por A, AV, CEAV, CETI y PS) y quienes no (TI). Esta división es la más importante del árbol y funciona como punto de partida para clasificar el riesgo. El comportamiento del grupo que sí pertenece a esos tipos particulares es evidente: la gran mayoría de ellos no es morosa, como lo muestra la primera rama del árbol. En este grupo el nivel estimado de morosidad es bajo (11%), y además constituye la mayor parte de la población analizada (86%). Es decir, según este árbol, la gran mayoría de asegurados con estos tipos de seguro presentan un riesgo muy bajo de caer en morosidad.

Para quienes no pertenecen a ese conjunto de tipos de aseguramiento donde predomina la no morosidad, el árbol continúa evaluando otros factores. En ese segundo nivel aparece otra característica relevante: si la persona es o no extranjera. Aquí se observa una diferencia marcada. Dentro de las personas cuyo tipo de aseguramiento no está en el primer grupo (es decir pertenecen a la categoría de trabajadores independientes), quienes sí son extranjeras muestran una probabilidad muy alta de ser morosas, cercana al 81%. Además, aunque este grupo es pequeño (respresenta el 2% de la población total), su nivel de riesgo es el más elevado de todo el árbol. Esto indica que, bajo estas condiciones específicas, el estatus de persona extranjera se asocia con una mayor vulnerabilidad o probabilidad de caer en morosidad. Desde una perspectiva de decisiones empresariales, este subgrupo podría considerarse riesgoso y una prioridad en términos de seguimiento y prevención de caer en mora (Note que esto también se visualizó en el análisis hecho en excel).

Si la persona no es extranjera, el árbol sigue profundizando y evalúa otro factor importante: el salario. En particular, el modelo identifica un punto de quiebre en ₡304.000. Dentro de este grupo de personas no extranjeras, el árbol divide a los asegurados según si su ingreso es inferior o superior a ese monto. Quienes ganan menos de ₡304.000 constituyen el 4% del total y, aunque el modelo los clasifica mayoritariamente como no morosos, el 0.40 indica que hay una presencia moderada de morosidad dentro del grupo. Por otro lado, quienes tienen ingresos iguales o superiores al umbral representan el 8% del total y el modelo los clasifica como morosos, mostrando con el 0.58 que es un grupo más mezclado, pero dominado por la morosidad. Es decir, este conjunto de asegurados no extranjeros con variaciones en su nivel salarial podría beneficiarse de programas preventivos, recordatorios de pago o estrategias de acompañamiento, dado que presentan patrones que incrementan su probabilidad relativa de caer en morosidad comparados con otras ramas.

En resumen, el árbol divide la población en rutas que dependen de preguntas secuenciales: primero, qué tipo de seguro tiene, luego, si es extranjera, finalmente, si su salario es inferior a ₡304.000. Estas preguntas corresponden a los factores que, según los datos, permiten distinguir mejor entre personas morosas y no morosas. El resultado final es un conjunto de perfiles diferenciados según el riesgo que presentan hacia la empresa.

A partir de este árbol de decisión se pueden extraer varias conclusiones relevantes para la toma de decisiones:

1.  **El tipo de aseguramiento es el factor más determinante:** Los asegurados pertenecientes a los tipos ASALARIADO, ASEGURADO VOLUNTARIO, CONVENIOS ESPECIALES DE ASEGURADOS VOLUNTARIOS, PENSIONADOS EN SU PROPIO SISTEMA y CONVENIOS ESPECIALES DE TRABAJADORES INDEPENDIENTES (A, AV, CEAV, CETI y PS) presentan, en general, un riesgo muy bajo. Es un grupo grande y estable que probablemente no requiere muchas intervenciones adicionales.

2.  **Entre quienes no pertenecen a esos tipos, ser extranjero aparece como una señal fuerte de riesgo:** Aunque este grupo es pequeño, concentra la mayor probabilidad de morosidad. Lo que indica que podría ser el grupo más importante para priorizar al tomar acción.

3.  **Los asegurados con tipo de aseuramiento de TRABAJADOR INDEPENDIENTE muestran un riesgo mayor de morosidad en comparación con los otros tipos de seguro:** En el árbol se observa que, dentro de este grupo, el modelo predice morosidad con mayor frecuencia, especialmente cuando se combinan otras características como ser extranjero o tener salarios superiores a ₡304.000. Esto indica que los trabajadores independientes conforman un segmento donde conviene aplicar políticas de monitoreo y acompañamiento.

Finalmente, el árbol sirve como una guía para saber donde enfocar recursos de prevención y cobro (en los grupos donde más probablemente se obtendrá un impacto significativo). Su utilidad radica en que simplifica los datos y presenta en una serie de rutas claras que facilitan la gestión de riesgos.
